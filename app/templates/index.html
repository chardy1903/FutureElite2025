{% extends "base.html" %}

{% block title %}Dashboard - FutureElite{% endblock %}

{% block content %}
<div class="px-4 py-6 sm:px-0">
    <!-- Header -->
    <div class="mb-8">
        <h1 id="dashboardTitle" class="text-3xl font-bold text-gray-900">Loading...</h1>
        <p id="dashboardSeason" class="mt-2 text-lg text-gray-600"></p>
    </div>

    <!-- Action Buttons -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-8">
        <button onclick="openMatchModal()" class="bg-qadsiah-red text-white px-6 py-3 rounded-lg font-medium hover:bg-red-700 transition-colors">
            Log Match
        </button>
        <button onclick="openFixturesModal()" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-blue-700 transition-colors">
            Upcoming Fixtures
        </button>
        <button onclick="generatePDF()" class="bg-green-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-green-700 transition-colors">
            Generate PDF
        </button>
        <button onclick="generateScoutPDF()" class="bg-purple-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-purple-700 transition-colors">
            Scout Report
        </button>
        <button onclick="openExportModal()" class="bg-gray-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-gray-700 transition-colors">
            Export/Import
        </button>
    </div>

    <!-- Season Stats -->
    <div class="bg-white shadow rounded-lg mb-8">
        <div class="px-4 py-5 sm:p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900">Statistics Summary</h3>
                <select id="statsPeriod" onchange="updateStatsPeriod()" class="text-sm border-gray-300 rounded-md shadow-sm focus:ring-qadsiah-red focus:border-qadsiah-red">
                    <option value="all_time">All Time</option>
                    <option value="season" selected>Current Season</option>
                    <option value="12_months">Last 12 Months</option>
                    <option value="6_months">Last 6 Months</option>
                    <option value="3_months">Last 3 Months</option>
                    <option value="last_month">Last Month</option>
                </select>
            </div>
            <div id="statsContainer" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <!-- Stats will be loaded client-side -->
            </div>
        </div>
    </div>

    <!-- Recent Matches -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div class="bg-white shadow rounded-lg">
            <div class="px-4 py-5 sm:p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Recent Matches</h3>
                <div id="recentMatchesContainer">
                    <p class="text-gray-500 text-center py-4">Loading...</p>
                </div>
            </div>
        </div>

        <!-- Recent Achievements -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-4 py-5 sm:p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Recent Achievements</h3>
                <div id="recentAchievementsContainer">
                    <p class="text-gray-500 text-center py-4">Loading...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Match Modal -->
<div id="matchModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900" id="matchModalTitle">Log Match</h3>
                <button onclick="closeMatchModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <form id="matchForm" onsubmit="saveMatch(event)">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Category</label>
                        <select name="category" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-qadsiah-red focus:border-qadsiah-red">
                            <option value="">Select category</option>
                            <option value="Pre-Season Friendly">Pre-Season Friendly</option>
                            <option value="League">League</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Date</label>
                        <input type="date" name="date" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-qadsiah-red focus:border-qadsiah-red">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Opponent</label>
                        <input type="text" name="opponent" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-qadsiah-red focus:border-qadsiah-red">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Location</label>
                        <input type="text" name="location" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-qadsiah-red focus:border-qadsiah-red">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Result</label>
                        <select name="result" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-qadsiah-red focus:border-qadsiah-red">
                            <option value="">Select result</option>
                            <option value="Win">Win</option>
                            <option value="Draw">Draw</option>
                            <option value="Loss">Loss</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Score</label>
                        <input type="text" name="score" placeholder="7 - 5" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-qadsiah-red focus:border-qadsiah-red">
                    </div>
                    
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Goals</label>
                            <input type="number" name="brodie_goals" min="0" value="0" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-qadsiah-red focus:border-qadsiah-red">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Assists</label>
                            <input type="number" name="brodie_assists" min="0" value="0" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-qadsiah-red focus:border-qadsiah-red">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Minutes</label>
                            <input type="number" name="minutes_played" min="0" value="0" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-qadsiah-red focus:border-qadsiah-red">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Notes</label>
                        <textarea name="notes" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-qadsiah-red focus:border-qadsiah-red"></textarea>
                    </div>
                    
                    <div class="flex items-center">
                        <input type="checkbox" name="is_fixture" id="is_fixture" class="h-4 w-4 text-qadsiah-red focus:ring-qadsiah-red border-gray-300 rounded">
                        <label for="is_fixture" class="ml-2 block text-sm text-gray-900">Upcoming fixture (no stats yet)</label>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="closeMatchModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-qadsiah-red rounded-md hover:bg-red-700">
                        Save Match
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Export/Import Modal -->
<div id="exportModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900">Export/Import Data</h3>
                <button onclick="closeExportModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <div class="space-y-4">
                <div class="text-center">
                    <button onclick="exportData()" class="w-full bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">
                        Export Data (ZIP)
                    </button>
                </div>
                
                <div class="border-t pt-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Import Data (ZIP)</label>
                    <input type="file" id="importFile" accept=".zip" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-qadsiah-red file:text-white hover:file:bg-red-700">
                    <button onclick="importData()" class="mt-2 w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                        Import Data
                    </button>
                </div>
                
                <div class="border-t pt-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Import Excel File</label>
                    <div class="mb-2">
                        <a href="/download-excel-template" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            Download Excel Template
                        </a>
                    </div>
                    <input type="file" id="importExcelFile" accept=".xlsx,.xls,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-600 file:text-white hover:file:bg-green-700">
                    <div class="mt-2 space-y-2">
                        <label class="flex items-center">
                            <input type="radio" name="importMode" value="replace" checked class="mr-2">
                            <span class="text-sm text-gray-700">Replace all matches</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="importMode" value="append" class="mr-2">
                            <span class="text-sm text-gray-700">Add to existing matches</span>
                        </label>
                    </div>
                    <button onclick="importExcelData()" class="mt-2 w-full bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">
                        Import Excel
                    </button>
                    <p class="mt-2 text-xs text-gray-500">Excel format: Opponent, Location, Date (DD/MM/YYYY), Category, Score, Goals, Assists, Minutes, Notes</p>
                    <p class="mt-1 text-xs text-amber-600">Note: If the file appears greyed out, make sure it's not open in Excel and that you have permission to read it.</p>
                </div>
                
                <div class="text-xs text-gray-500 text-center">
                    <p>All data is stored locally. No cloud or tracking.</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentMatchId = null;

function openMatchModal(matchId = null) {
    currentMatchId = matchId;
    const modal = document.getElementById('matchModal');
    const form = document.getElementById('matchForm');
    const title = document.getElementById('matchModalTitle');
    
    if (matchId) {
        title.textContent = 'Edit Match';
        loadMatchData(matchId);
    } else {
        title.textContent = 'Log Match';
        form.reset();
        document.querySelector('input[name="is_fixture"]').checked = false;
    }
    
    modal.classList.remove('hidden');
}

function closeMatchModal() {
    document.getElementById('matchModal').classList.add('hidden');
    currentMatchId = null;
}

function openFixturesModal() {
    window.location.href = '/matches';
}

function openExportModal() {
    document.getElementById('exportModal').classList.remove('hidden');
}

function closeExportModal() {
    document.getElementById('exportModal').classList.add('hidden');
}

async function loadMatchData(matchId) {
    try {
        const response = await apiCall(`/matches/${matchId}`);
        const match = response.match;
        
        document.querySelector('select[name="category"]').value = match.category;
        document.querySelector('input[name="date"]').value = formatDateForInput(match.date);
        document.querySelector('input[name="opponent"]').value = match.opponent;
        document.querySelector('input[name="location"]').value = match.location;
        document.querySelector('select[name="result"]').value = match.result || '';
        document.querySelector('input[name="score"]').value = match.score || '';
        document.querySelector('input[name="brodie_goals"]').value = match.brodie_goals;
        document.querySelector('input[name="brodie_assists"]').value = match.brodie_assists;
        document.querySelector('input[name="minutes_played"]').value = match.minutes_played;
        document.querySelector('textarea[name="notes"]').value = match.notes || '';
        document.querySelector('input[name="is_fixture"]').checked = match.is_fixture;
    } catch (error) {
        console.error('Error loading match data:', error);
    }
}

async function saveMatch(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const data = Object.fromEntries(formData.entries());
    
    // Convert date format
    if (data.date) {
        data.date = formatDateForDisplay(data.date);
    }
    
    // Convert numeric fields
    data.brodie_goals = parseInt(data.brodie_goals) || 0;
    data.brodie_assists = parseInt(data.brodie_assists) || 0;
    data.minutes_played = parseInt(data.minutes_played) || 0;
    data.is_fixture = data.is_fixture === 'on';
    
    try {
        showLoading('Saving match...');
        
        const url = currentMatchId ? `/matches/${currentMatchId}` : '/matches';
        const method = currentMatchId ? 'PUT' : 'POST';
        
        await apiCall(url, {
            method: method,
            body: JSON.stringify(data)
        });
        
        hideLoading();
        showToast('Match saved successfully!');
        closeMatchModal();
        
        // Reload page to show updated data
        setTimeout(() => window.location.reload(), 1000);
        
    } catch (error) {
        hideLoading();
        console.error('Error saving match:', error);
    }
}

async function generateScoutPDF() {
    try {
        showLoading('Generating scout report...');
        
        // Get current period selection
        const period = document.getElementById('statsPeriod')?.value || 'all_time';
        
        // Get all data from client storage
        await ensureStorageReady();
        const data = await clientStorage.exportData();
        data.period = period;
        
        const response = await fetch('/scout-pdf', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.errors ? error.errors.join(', ') : 'Failed to generate scout PDF');
        }
        
        // Get the PDF blob
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = response.headers.get('Content-Disposition')?.split('filename=')[1]?.replace(/"/g, '') || 'scout_report.pdf';
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        hideLoading();
        showToast('Scout report generated successfully!', 'success');
        
    } catch (error) {
        hideLoading();
        console.error('Error generating scout PDF:', error);
        showToast('Error generating scout PDF: ' + error.message, 'error');
    }
}

async function generatePDF() {
    try {
        showLoading('Generating PDF...');
        
        // Get current period selection
        const period = document.getElementById('statsPeriod')?.value || 'all_time';
        
        // Get all data from client storage
        await ensureStorageReady();
        const data = await clientStorage.exportData();
        data.period = period;
        
        const response = await fetch('/pdf', { 
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        if (!response.ok) {
            throw new Error('Failed to generate PDF');
        }
        
        // Get the filename from the Content-Disposition header
        const contentDisposition = response.headers.get('Content-Disposition');
        let filename = 'FutureElite_Tracker_Report.pdf';
        if (contentDisposition) {
            const filenameMatch = contentDisposition.match(/filename="(.+)"/);
            if (filenameMatch) {
                filename = filenameMatch[1];
            }
        }
        
        // Create blob and download
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        hideLoading();
        showToast('PDF generated and downloaded successfully!');
        
    } catch (error) {
        hideLoading();
        console.error('Error generating PDF:', error);
        showToast('Error generating PDF: ' + error.message, 'error');
    }
}

async function exportData() {
    try {
        showLoading('Exporting data...');
        
        await ensureStorageReady();
        const data = await clientStorage.exportData();
        
        // Create JSON file (or ZIP if JSZip is available)
        const jsonStr = JSON.stringify(data, null, 2);
        const blob = new Blob([jsonStr], { type: 'application/json' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'FutureElite_Backup.json';
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        hideLoading();
        showToast('Data exported successfully!');
        closeExportModal();
        
    } catch (error) {
        hideLoading();
        console.error('Error exporting data:', error);
        showToast('Error exporting data: ' + error.message, 'error');
    }
}

async function importData() {
    const fileInput = document.getElementById('importFile');
    const file = fileInput.files[0];
    
    if (!file) {
        showToast('Please select a file to import', 'error');
        return;
    }
    
    try {
        showLoading('Importing data...');
        
        await ensureStorageReady();
        
        // Read file as text
        const text = await file.text();
        const data = JSON.parse(text);
        
        // Import data
        await clientStorage.importData(data);
        
        hideLoading();
        showToast('Data imported successfully!');
        closeExportModal();
        setTimeout(() => window.location.reload(), 1000);
        
    } catch (error) {
        hideLoading();
        console.error('Error importing data:', error);
        showToast('Error importing data: ' + error.message, 'error');
    }
}

async function importExcelData() {
    const fileInput = document.getElementById('importExcelFile');
    const file = fileInput.files[0];
    
    if (!file) {
        showToast('Please select an Excel file to import', 'error');
        return;
    }
    
    try {
        await ensureStorageReady();
        
        // Check authentication
        if (!clientAuth.isAuthenticated()) {
            showToast('Please log in to import data', 'error');
            return;
        }
        
        showLoading('Importing Excel file...');
        
        const formData = new FormData();
        formData.append('file', file);
        
        // Get import mode
        const importMode = document.querySelector('input[name="importMode"]:checked').value;
        formData.append('import_mode', importMode);
        
        const response = await fetch('/import-excel', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Save matches to client-side storage
            const importedMatches = result.matches || [];
            
            const currentUserId = clientStorage.getCurrentUserId();
            if (!currentUserId) {
                throw new Error('User must be logged in to import data');
            }
            
            if (importMode === 'replace') {
                // Replace mode: delete all existing matches for current user, then add imported ones
                const existingMatches = await clientStorage.getAllMatches();
                
                // Delete all current user's matches
                for (const match of existingMatches) {
                    if (match.user_id === currentUserId) {
                        await clientStorage.deleteMatch(match.id);
                    }
                }
                
                // Add imported matches with current user_id
                for (const matchData of importedMatches) {
                    matchData.user_id = currentUserId;
                    await clientStorage.saveMatch(matchData);
                }
            } else {
                // Append mode: add imported matches, ensuring unique IDs
                const existingMatches = await clientStorage.getAllMatches();
                const existingIds = new Set(existingMatches.map(m => m.id));
                
                for (const matchData of importedMatches) {
                    // Ensure unique ID
                    if (existingIds.has(matchData.id)) {
                        matchData.id = 'match_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    }
                    matchData.user_id = currentUserId;
                    await clientStorage.saveMatch(matchData);
                    existingIds.add(matchData.id);
                }
            }
            
            hideLoading();
            const message = `Successfully imported ${result.imported} matches${result.errors.length > 0 ? ' (with some warnings)' : ''}!`;
            showToast(message, 'success');
            if (result.errors.length > 0) {
                console.warn('Import warnings:', result.errors);
            }
            closeExportModal();
            
            // Reload dashboard data instead of full page reload
            if (typeof loadDashboardData === 'function') {
                await loadDashboardData();
            } else {
                setTimeout(() => window.location.reload(), 1000);
            }
        } else {
            throw new Error(result.errors.join(', '));
        }
        
    } catch (error) {
        hideLoading();
        console.error('Error importing Excel:', error);
        showToast('Error importing Excel: ' + error.message, 'error');
    }
}

function editMatch(matchId) {
    openMatchModal(matchId);
}

// Helper functions for template
function getResultColor(result) {
    switch(result) {
        case 'Win': return 'text-green-600';
        case 'Draw': return 'text-yellow-600';
        case 'Loss': return 'text-red-600';
        default: return 'text-gray-600';
    }
}

function getCategoryBadgeColor(category) {
    switch(category) {
        case 'Pre-Season Friendly': return 'bg-blue-100 text-blue-800';
        case 'League': return 'bg-green-100 text-green-800';
        default: return 'bg-gray-100 text-gray-800';
    }
}

async function loadDashboardData() {
    try {
        await ensureStorageReady();
        
        // Check authentication
        if (!clientAuth.isAuthenticated()) {
            window.location.href = '/login';
            return;
        }
        
        // Load settings
        const settings = await clientStorage.loadSettings();
        document.getElementById('dashboardTitle').textContent = 
            `${settings.club_name || 'Club'} - ${settings.player_name || 'Player'}`;
        document.getElementById('dashboardSeason').textContent = 
            settings.season_year ? `Season ${settings.season_year}` : '';
        
        // Load and display stats
        await updateStatsPeriod();
        
        // Load recent matches
        const matches = await clientStorage.getAllMatches();
        const recentMatches = matches
            .filter(m => !m.is_fixture)
            .sort((a, b) => {
                try {
                    const dateA = new Date(a.date.split(' ').reverse().join('-'));
                    const dateB = new Date(b.date.split(' ').reverse().join('-'));
                    return dateB - dateA;
                } catch {
                    return 0;
                }
            })
            .slice(0, 5);
        
        const matchesContainer = document.getElementById('recentMatchesContainer');
        if (recentMatches.length === 0) {
            matchesContainer.innerHTML = '<p class="text-gray-500 text-center py-4">No matches logged yet</p>';
        } else {
            matchesContainer.innerHTML = recentMatches.map(match => `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg mb-3">
                    <div class="flex-1">
                        <div class="flex items-center space-x-2">
                            <span class="text-sm font-medium text-gray-900">${match.opponent || 'Unknown'}</span>
                            <span class="px-2 py-1 text-xs rounded-full ${getCategoryBadgeColor(match.category || '')}">
                                ${match.category || ''}
                            </span>
                        </div>
                        <div class="text-sm text-gray-600">${match.date || ''} • ${match.location || ''}</div>
                        ${match.result ? `<div class="text-sm ${getResultColor(match.result)}">${match.result} ${match.score || ''}</div>` : ''}
                    </div>
                    <div class="text-right">
                        <div class="text-sm font-medium text-gray-900">${match.brodie_goals || 0}G ${match.brodie_assists || 0}A</div>
                        <div class="text-xs text-gray-600">${match.minutes_played || 0}m</div>
                        <button onclick="editMatch('${match.id}')" class="mt-2 text-qadsiah-red hover:text-red-700 text-sm font-medium">Edit</button>
                    </div>
                </div>
            `).join('');
        }
        
        // Load recent achievements
        const achievements = await clientStorage.getAllAchievements();
        const recentAchievements = achievements
            .sort((a, b) => {
                try {
                    const dateA = new Date(a.date.split(' ').reverse().join('-'));
                    const dateB = new Date(b.date.split(' ').reverse().join('-'));
                    return dateB - dateA;
                } catch {
                    return 0;
                }
            })
            .slice(0, 5);
        
        const achievementsContainer = document.getElementById('recentAchievementsContainer');
        if (recentAchievements.length === 0) {
            achievementsContainer.innerHTML = `
                <div class="text-center py-8">
                    <p class="text-gray-500 mb-2">No achievements yet</p>
                    <a href="/achievements" class="text-sm text-qadsiah-red hover:text-red-700 font-medium">
                        Add Your First Achievement →
                    </a>
                </div>
            `;
        } else {
            achievementsContainer.innerHTML = recentAchievements.map(ach => `
                <div class="flex items-start justify-between p-3 bg-gradient-to-r from-yellow-50 to-amber-50 rounded-lg border border-yellow-200 mb-3">
                    <div class="flex-1">
                        <div class="flex items-center space-x-2 mb-1">
                            <span class="text-sm font-semibold text-gray-900">${ach.title || ''}</span>
                            <span class="px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800 font-medium">
                                ${ach.category || ''}
                            </span>
                        </div>
                        ${ach.description ? `<div class="text-sm text-gray-700 mb-1">${ach.description}</div>` : ''}
                        <div class="flex items-center space-x-2 text-xs text-gray-500">
                            <span>${ach.date || ''}</span>
                            ${ach.season ? `<span>•</span><span>${ach.season}</span>` : ''}
                        </div>
                    </div>
                </div>
            `).join('') + `
                <div class="mt-4 text-center">
                    <a href="/achievements" class="text-sm text-qadsiah-red hover:text-red-700 font-medium">
                        View All Achievements →
                    </a>
                </div>
            `;
        }
        
    } catch (error) {
        console.error('Error loading dashboard data:', error);
        showToast('Error loading dashboard: ' + error.message, 'error');
    }
}

async function updateStatsPeriod() {
    const period = document.getElementById('statsPeriod').value;
    const container = document.getElementById('statsContainer');
    
    try {
        await ensureStorageReady();
        const stats = await clientStorage.getSeasonStats(null, period);
        const avgMinutes = stats.total_matches > 0 ? (stats.minutes / stats.total_matches).toFixed(1) : '0.0';
        
        container.innerHTML = `
            <div class="text-center">
                <div class="text-2xl font-bold text-qadsiah-red">${stats.total_matches}</div>
                <div class="text-sm text-gray-600">Matches</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-green-600">${stats.wins}</div>
                <div class="text-sm text-gray-600">Wins</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-yellow-600">${stats.draws}</div>
                <div class="text-sm text-gray-600">Draws</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-red-600">${stats.losses}</div>
                <div class="text-sm text-gray-600">Losses</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-blue-600">${stats.goals}</div>
                <div class="text-sm text-gray-600">Goals</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-purple-600">${stats.assists}</div>
                <div class="text-sm text-gray-600">Assists</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-indigo-600">${stats.minutes}</div>
                <div class="text-sm text-gray-600">Minutes</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-gray-600">${avgMinutes}</div>
                <div class="text-sm text-gray-600">Avg Minutes</div>
            </div>
        `;
    } catch (error) {
        console.error('Error updating statistics:', error);
        showToast('Error loading statistics: ' + error.message, 'error');
    }
}

// Load dashboard data on page load
document.addEventListener('DOMContentLoaded', function() {
    loadDashboardData();
});
</script>
{% endblock %}
