{% extends "base.html" %}

{% block title %}Dashboard - FutureElite{% endblock %}

{% block content %}
<div class="px-4 py-6 sm:px-0">
    <!-- Header -->
    <div class="mb-8">
        <h1 id="dashboardTitle" class="text-3xl font-bold text-gray-900">Loading...</h1>
        <p id="dashboardSeason" class="mt-2 text-lg text-gray-600"></p>
    </div>

    <!-- Action Buttons -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-8">
        <button onclick="openMatchModal()" class="bg-qadsiah-red text-white px-6 py-3 rounded-lg font-medium hover:bg-red-700 transition-colors">
            Log Match
        </button>
        <button onclick="generatePDF()" class="bg-green-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-green-700 transition-colors">
            Season Tracker Report
        </button>
        <button onclick="generateScoutPDF()" class="bg-purple-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-purple-700 transition-colors">
            Scout Report
        </button>
        <button onclick="openExportModal()" class="bg-gray-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-gray-700 transition-colors">
            Export/Import
        </button>
    </div>

    <!-- Season Stats -->
    <div class="bg-white shadow rounded-lg mb-8">
        <div class="px-4 py-5 sm:p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900">Statistics Summary</h3>
                <select id="statsPeriod" onchange="updateStatsPeriod()" class="text-sm border-gray-300 rounded-md shadow-sm focus:ring-qadsiah-red focus:border-qadsiah-red">
                    <option value="all_time">All Time</option>
                    <option value="season" selected>Current Season</option>
                    <option value="12_months">Last 12 Months</option>
                    <option value="6_months">Last 6 Months</option>
                    <option value="3_months">Last 3 Months</option>
                    <option value="last_month">Last Month</option>
                </select>
            </div>
            <div id="statsContainer" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <!-- Stats will be loaded client-side -->
            </div>
        </div>
    </div>

    <!-- Performance Report Widget -->
    <div class="bg-gradient-to-br from-blue-900 to-blue-700 rounded-lg shadow-xl mb-8 overflow-hidden">
        <div class="bg-white bg-opacity-10 backdrop-blur-sm px-6 py-4">
            <h2 class="text-2xl font-bold text-white">Youth Player Performance Report</h2>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 p-4 sm:p-6">
            <!-- Player Profile (Left Top) -->
            <div class="bg-white rounded-lg shadow-lg p-4 sm:p-6">
                <div class="flex items-start space-x-4 mb-4">
                    <div class="flex-shrink-0">
                        <div id="playerPhotoContainer" class="w-20 h-20 sm:w-24 sm:h-24 bg-gray-200 rounded-lg flex items-center justify-center overflow-hidden relative" style="min-width: 80px; min-height: 80px; max-width: 96px; max-height: 96px;">
                            <svg class="w-12 h-12 sm:w-16 sm:h-16 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
                            </svg>
                        </div>
                    </div>
                    <div class="flex-1">
                        <h3 id="playerNameHeader" class="text-xl font-bold text-gray-900 mb-2">Player</h3>
                        <div class="space-y-1 text-sm text-gray-600">
                            <p><span class="font-medium">Current Club:</span> <span id="playerClub">-</span></p>
                            <p><span class="font-medium">Position:</span> <span id="playerPosition">-</span></p>
                            <p><span class="font-medium">Dominant Foot:</span> <span id="playerFoot">-</span></p>
                            <p><span class="font-medium">Season:</span> <span id="playerSeason">-</span></p>
                        </div>
                    </div>
                </div>
                <div class="border-t pt-4 mt-4">
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <p class="text-gray-500">Age Group</p>
                            <p id="playerAgeGroup" class="font-semibold text-gray-900">-</p>
                        </div>
                        <div>
                            <p class="text-gray-500">Height</p>
                            <p id="playerHeight" class="font-semibold text-gray-900">-</p>
                        </div>
                        <div>
                            <p class="text-gray-500">Weight</p>
                            <p id="playerWeight" class="font-semibold text-gray-900">-</p>
                        </div>
                        <div>
                            <p class="text-gray-500">PHV Status</p>
                            <p id="playerPHVStatus" class="font-semibold text-gray-900">-</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Physical Development Profile (Right Top) -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-lg font-bold text-gray-900 mb-4">Physical Development Profile</h3>
                <div id="physicalMetricsContainer" class="space-y-3 mb-4">
                    <div class="flex items-center justify-between p-3 bg-blue-50 rounded-lg">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center">
                                <span class="text-white text-xl">üèÉ</span>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Sprint Speed</p>
                                <p id="sprintSpeed" class="font-semibold text-gray-900">-</p>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-green-600 rounded-full flex items-center justify-center">
                                <span class="text-white text-xl">‚¨ÜÔ∏è</span>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Vertical Jump</p>
                                <p id="verticalJump" class="font-semibold text-gray-900">-</p>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center justify-between p-3 bg-purple-50 rounded-lg">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-purple-600 rounded-full flex items-center justify-center">
                                <span class="text-white text-xl">üí™</span>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Beep Test</p>
                                <p id="beepTest" class="font-semibold text-gray-900">-</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="phvBadge" class="text-center">
                    <span class="inline-flex items-center px-4 py-2 rounded-full text-sm font-medium bg-green-100 text-green-800">
                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                        </svg>
                        <span id="phvStageText">PHV Status</span>
                    </span>
                </div>
            </div>

            <!-- Match & Performance Summary (Left Bottom) -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-lg font-bold text-gray-900 mb-4">Match & Performance Summary</h3>
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div class="bg-blue-600 text-white p-4 rounded-lg text-center">
                        <p class="text-2xl font-bold" id="totalMatches">0</p>
                        <p class="text-sm opacity-90">Matches</p>
                    </div>
                    <div class="bg-green-600 text-white p-4 rounded-lg text-center">
                        <p class="text-2xl font-bold" id="totalGoals">0</p>
                        <p class="text-sm opacity-90">Total Goals</p>
                    </div>
                    <div class="bg-purple-600 text-white p-4 rounded-lg text-center">
                        <p class="text-2xl font-bold" id="totalAssists">0</p>
                        <p class="text-sm opacity-90">Total Assists</p>
                    </div>
                    <div class="bg-orange-600 text-white p-4 rounded-lg text-center">
                        <p class="text-2xl font-bold" id="totalMinutes">0</p>
                        <p class="text-sm opacity-90">Minutes Played</p>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3 mt-4">
                    <div class="bg-gray-100 p-3 rounded-lg text-center">
                        <p class="text-sm text-gray-600">Goals Per 60 Mins</p>
                        <p class="text-lg font-bold text-gray-900" id="goalsPer60">0.00</p>
                    </div>
                    <div class="bg-gray-100 p-3 rounded-lg text-center">
                        <p class="text-sm text-gray-600">Minutes Per Contribution</p>
                        <p class="text-lg font-bold text-gray-900" id="minutesPerContribution">-</p>
                    </div>
                </div>
            </div>

            <!-- Scout Snapshot (Right Bottom) -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-lg font-bold text-gray-900 mb-4">Scout Snapshot</h3>
                <div class="mb-4">
                    <h4 class="text-sm font-semibold text-gray-700 mb-2">Key Strengths</h4>
                    <ul id="keyStrengths" class="list-disc list-inside space-y-1 text-sm text-gray-600">
                        <li>Loading strengths...</li>
                    </ul>
                </div>
                <div class="mb-4 space-y-2">
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600">Goals Per 60 Mins:</span>
                        <span class="font-semibold text-gray-900" id="scoutGoalsPer60">0.00</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600">Assists Per 60 Mins:</span>
                        <span class="font-semibold text-gray-900" id="scoutAssistsPer60">0.00</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600">Goal Contrib. Per 60:</span>
                        <span class="font-semibold text-gray-900" id="scoutGoalContribPer60">0.00</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600">Minutes Per Goal:</span>
                        <span class="font-semibold text-gray-900" id="scoutMinutesPerGoal">-</span>
                    </div>
                </div>
                <button onclick="generateScoutPDF()" class="w-full bg-green-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-green-700 transition-colors">
                    Export Report (PDF)
                </button>
            </div>
        </div>
    </div>

    <!-- Recent Matches -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div class="bg-white shadow rounded-lg">
            <div class="px-4 py-5 sm:p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Recent Matches</h3>
                <div id="recentMatchesContainer">
                    <p class="text-gray-500 text-center py-4">Loading...</p>
                </div>
            </div>
        </div>

        <!-- Recent Achievements -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-4 py-5 sm:p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Recent Achievements</h3>
                <div id="recentAchievementsContainer">
                    <p class="text-gray-500 text-center py-4">Loading...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Match Modal -->
<div id="matchModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900" id="matchModalTitle">Log Match</h3>
                <button onclick="closeMatchModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <form id="matchForm" onsubmit="saveMatch(event)">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Category</label>
                        <select name="category" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-qadsiah-red focus:border-qadsiah-red">
                            <option value="">Select category</option>
                            <option value="Pre-Season Friendly">Pre-Season Friendly</option>
                            <option value="League">League</option>
                            <option value="Friendly">Friendly</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Date</label>
                        <input type="date" name="date" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-qadsiah-red focus:border-qadsiah-red">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Opponent</label>
                        <input type="text" name="opponent" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-qadsiah-red focus:border-qadsiah-red">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Location</label>
                        <input type="text" name="location" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-qadsiah-red focus:border-qadsiah-red">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Result</label>
                        <select name="result" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-qadsiah-red focus:border-qadsiah-red">
                            <option value="">Select result</option>
                            <option value="Win">Win</option>
                            <option value="Draw">Draw</option>
                            <option value="Loss">Loss</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Score</label>
                        <input type="text" name="score" placeholder="7 - 5" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-qadsiah-red focus:border-qadsiah-red">
                    </div>
                    
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Goals</label>
                            <input type="number" name="brodie_goals" min="0" value="0" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-qadsiah-red focus:border-qadsiah-red">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Assists</label>
                            <input type="number" name="brodie_assists" min="0" value="0" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-qadsiah-red focus:border-qadsiah-red">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Minutes</label>
                            <input type="number" name="minutes_played" min="0" value="0" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-qadsiah-red focus:border-qadsiah-red">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Notes</label>
                        <textarea name="notes" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-qadsiah-red focus:border-qadsiah-red"></textarea>
                    </div>
                    
                </div>
                
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="closeMatchModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-qadsiah-red rounded-md hover:bg-red-700">
                        Save Match
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Export/Import Modal -->
<div id="exportModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900">Export/Import Data</h3>
                <button onclick="closeExportModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <div class="space-y-6">
                <!-- Export -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Export Data</label>
                    <button onclick="exportData()" class="w-full bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">
                        Export to Excel
                    </button>
                </div>
                
                <!-- Import -->
                <div class="border-t pt-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Import Data</label>
                    <input type="file" id="importFile" accept=".xlsx,.xls,.zip,application/json" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-qadsiah-red file:text-white hover:file:bg-red-700">
                    <button onclick="importData()" class="mt-2 w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                        Import
                    </button>
                    <p class="mt-2 text-xs text-gray-500">Supports Excel files (.xlsx, .xls) or backup files (.zip, .json)</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentMatchId = null;

function openMatchModal(matchId = null) {
    currentMatchId = matchId;
    const modal = document.getElementById('matchModal');
    const form = document.getElementById('matchForm');
    const title = document.getElementById('matchModalTitle');
    
    if (matchId) {
        title.textContent = 'Edit Match';
        loadMatchData(matchId);
    } else {
        title.textContent = 'Log Match';
        form.reset();
    }
    
    modal.classList.remove('hidden');
}

function closeMatchModal() {
    document.getElementById('matchModal').classList.add('hidden');
    currentMatchId = null;
}


function openExportModal() {
    document.getElementById('exportModal').classList.remove('hidden');
}

function closeExportModal() {
    document.getElementById('exportModal').classList.add('hidden');
}

async function loadMatchData(matchId) {
    try {
        const response = await apiCall(`/matches/${matchId}`);
        const match = response.match;
        
        document.querySelector('select[name="category"]').value = match.category;
        document.querySelector('input[name="date"]').value = formatDateForInput(match.date);
        document.querySelector('input[name="opponent"]').value = match.opponent;
        document.querySelector('input[name="location"]').value = match.location;
        document.querySelector('select[name="result"]').value = match.result || '';
        document.querySelector('input[name="score"]').value = match.score || '';
        document.querySelector('input[name="brodie_goals"]').value = match.brodie_goals;
        document.querySelector('input[name="brodie_assists"]').value = match.brodie_assists;
        document.querySelector('input[name="minutes_played"]').value = match.minutes_played;
        document.querySelector('textarea[name="notes"]').value = match.notes || '';
    } catch (error) {
        console.error('Error loading match data:', error);
    }
}

async function saveMatch(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const data = Object.fromEntries(formData.entries());
    
    // Convert date format
    if (data.date) {
        data.date = formatDateForDisplay(data.date);
    }
    
    // Convert numeric fields
    data.brodie_goals = parseInt(data.brodie_goals) || 0;
    data.brodie_assists = parseInt(data.brodie_assists) || 0;
    data.minutes_played = parseInt(data.minutes_played) || 0;
    data.is_fixture = false; // Always false - fixtures removed
    
    try {
        showLoading('Saving match...');
        
        const url = currentMatchId ? `/matches/${currentMatchId}` : '/matches';
        const method = currentMatchId ? 'PUT' : 'POST';
        
        await apiCall(url, {
            method: method,
            body: JSON.stringify(data)
        });
        
        hideLoading();
        showToast('Match saved successfully!');
        closeMatchModal();
        
        // Reload page to show updated data
        setTimeout(() => window.location.reload(), 1000);
        
    } catch (error) {
        hideLoading();
        console.error('Error saving match:', error);
    }
}

// Free tier limits
const FREE_TIER_LIMITS = {
    matches: 5,
    achievements: 1,
    physical_measurements: 2,
    physical_metrics: 2,
    references: 1
};

// Check if user has active subscription
async function checkSubscriptionAccess() {
    try {
        await ensureStorageReady();
        const userId = clientStorage.getCurrentUserId();
        if (!userId) {
            return false;
        }
        
        // Try to get subscription from server first
        try {
            const headers = {
                'Content-Type': 'application/json'
            };
            
            // Add CSRF token if available
            try {
                const csrfToken = await csrfManager.getToken();
                if (csrfToken) {
                    headers['X-CSRFToken'] = csrfToken;
                }
            } catch (error) {
                console.warn('Failed to get CSRF token:', error);
            }
            
            const response = await fetch('/api/subscription/status', {
                method: 'POST',
                headers: headers,
                credentials: 'include',
                body: JSON.stringify({ user_id: userId })
            });
            const data = await response.json();
            if (data.success && data.subscription && data.subscription.has_access) {
                // Sync to client storage
                await clientStorage.saveSubscription(data.subscription);
                return true;
            }
        } catch (e) {
            console.warn('Could not check subscription from server:', e);
        }
        
        // Fallback to client storage
        const subscription = await clientStorage.getSubscription(userId);
        return subscription && subscription.status === 'active';
    } catch (error) {
        console.error('Error checking subscription:', error);
        return false;
    }
}

// Check if user can add more of a resource type
async function checkResourceLimit(resourceType) {
    const hasAccess = await checkSubscriptionAccess();
    if (hasAccess) {
        return { canAdd: true, limit: null, current: null };
    }
    
    const limit = FREE_TIER_LIMITS[resourceType];
    if (!limit) {
        return { canAdd: true, limit: null, current: null };
    }
    
    await ensureStorageReady();
    let current = 0;
    
    try {
        if (resourceType === 'matches') {
            const matches = await clientStorage.getAllMatches();
            current = matches.length;
        } else if (resourceType === 'achievements') {
            const achievements = await clientStorage.getAllAchievements();
            current = achievements.length;
        } else if (resourceType === 'physical_measurements') {
            const measurements = await clientStorage.getAllPhysicalMeasurements();
            current = measurements.length;
        } else if (resourceType === 'physical_metrics') {
            const metrics = await clientStorage.getAllPhysicalMetrics();
            current = metrics.length;
        } else if (resourceType === 'references') {
            const references = await clientStorage.getAllReferences();
            current = references.length;
        }
    } catch (e) {
        console.error('Error checking resource limit:', e);
    }
    
    return {
        canAdd: current < limit,
        limit: limit,
        current: current,
        resourceType: resourceType
    };
}

// Show limit reached message
function showLimitReachedMessage(resourceType, limit, current) {
    const resourceNames = {
        matches: 'matches',
        achievements: 'achievements',
        physical_measurements: 'measurements',
        physical_metrics: 'performance metrics',
        references: 'references'
    };
    
    const name = resourceNames[resourceType] || resourceType;
    const message = `Free tier limit reached: ${limit} ${name}. You currently have ${current} ${name}. Subscribe to unlock unlimited entries.`;
    
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50';
    modal.innerHTML = `
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Free Tier Limit</h3>
                    <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="mb-4">
                    <p class="text-sm text-gray-600 mb-4">${message}</p>
                    <p class="text-sm text-gray-500 mb-2">Subscribe to unlock:</p>
                    <ul class="list-disc list-inside text-sm text-gray-600 space-y-1">
                        <li>Unlimited ${name}</li>
                        <li>PDF report generation</li>
                        <li>PHV calculation</li>
                        <li>All premium features</li>
                    </ul>
                </div>
                <div class="flex justify-end space-x-3">
                    <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200">
                        Cancel
                    </button>
                    <button onclick="window.location.href='/subscription'" class="px-4 py-2 text-sm font-medium text-white bg-qadsiah-red rounded-md hover:bg-red-700">
                        View Plans
                    </button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.remove();
        }
    });
}

// Show premium feature message
function showPremiumFeatureMessage(featureName) {
    // Create a modal-style message
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50';
    modal.innerHTML = `
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Premium Feature</h3>
                    <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="mb-4">
                    <p class="text-sm text-gray-600 mb-4">PDF generation is a premium feature. Please subscribe to unlock this feature and generate professional reports.</p>
                    <p class="text-sm text-gray-500 mb-2">Subscribe to unlock:</p>
                    <ul class="list-disc list-inside text-sm text-gray-600 space-y-1">
                        <li>Professional PDF reports</li>
                        <li>Scout-friendly reports</li>
                        <li>Export your complete performance history</li>
                    </ul>
                </div>
                <div class="flex justify-end space-x-3">
                    <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200">
                        Cancel
                    </button>
                    <button onclick="window.location.href='/subscription'" class="px-4 py-2 text-sm font-medium text-white bg-qadsiah-red rounded-md hover:bg-red-700">
                        View Plans
                    </button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    
    // Close on background click
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.remove();
        }
    });
}

async function generateScoutPDF() {
    try {
        // Check subscription before generating
        const hasAccess = await checkSubscriptionAccess();
        if (!hasAccess) {
            showPremiumFeatureMessage('Scout Report Generation');
            return;
        }
        
        showLoading('Generating scout report...');
        
        // Get current period selection
        const period = document.getElementById('statsPeriod')?.value || 'all_time';
        
        // Get all data from client storage
        await ensureStorageReady();
        let data = await clientStorage.exportData();
        
        // Load latest settings from server to ensure we have player profile data
        try {
            const serverSettings = await apiCall('/api/settings');
            if (serverSettings.success && serverSettings.settings) {
                // Merge server settings (source of truth) with client settings
                data.settings = { ...data.settings, ...serverSettings.settings };
            }
        } catch (e) {
            console.warn('Could not load settings from server, using client storage:', e);
        }
        
        data.period = period;
        
        const headers = {
            'Content-Type': 'application/json'
        };
        
        // Add CSRF token if available
        try {
            const csrfToken = await csrfManager.getToken();
            if (csrfToken) {
                headers['X-CSRFToken'] = csrfToken;
            }
        } catch (error) {
            console.warn('Failed to get CSRF token:', error);
        }
        
        const response = await fetch('/scout-pdf', {
            method: 'POST',
            headers: headers,
            credentials: 'include',
            body: JSON.stringify(data)
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.errors ? error.errors.join(', ') : 'Failed to generate scout PDF');
        }
        
        // Get the PDF blob
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = response.headers.get('Content-Disposition')?.split('filename=')[1]?.replace(/"/g, '') || 'scout_report.pdf';
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        hideLoading();
        showToast('Scout report generated successfully!', 'success');
        
    } catch (error) {
        hideLoading();
        console.error('Error generating scout PDF:', error);
        showToast('Error generating scout PDF: ' + error.message, 'error');
    }
}

async function generatePDF() {
    try {
        // Check subscription before generating
        const hasAccess = await checkSubscriptionAccess();
        if (!hasAccess) {
            showPremiumFeatureMessage('PDF Generation');
            return;
        }
        
        showLoading('Generating PDF...');
        
        // Get current period selection
        const period = document.getElementById('statsPeriod')?.value || 'all_time';
        
        // Get all data from client storage
        await ensureStorageReady();
        let data = await clientStorage.exportData();
        
        // Load latest settings from server to ensure we have player profile data
        try {
            const serverSettings = await apiCall('/api/settings');
            if (serverSettings.success && serverSettings.settings) {
                // Merge server settings (source of truth) with client settings
                data.settings = { ...data.settings, ...serverSettings.settings };
            }
        } catch (e) {
            console.warn('Could not load settings from server, using client storage:', e);
        }
        
        data.period = period;
        
        const headers = {
            'Content-Type': 'application/json'
        };
        
        // Add CSRF token if available
        try {
            const csrfToken = await csrfManager.getToken();
            if (csrfToken) {
                headers['X-CSRFToken'] = csrfToken;
            }
        } catch (error) {
            console.warn('Failed to get CSRF token:', error);
        }
        
        const response = await fetch('/pdf', {
            method: 'POST',
            headers: headers,
            credentials: 'include',
            body: JSON.stringify(data)
        });
        
        if (!response.ok) {
            throw new Error('Failed to generate PDF');
        }
        
        // Get the filename from the Content-Disposition header
        const contentDisposition = response.headers.get('Content-Disposition');
        let filename = 'FutureElite_Tracker_Report.pdf';
        if (contentDisposition) {
            const filenameMatch = contentDisposition.match(/filename="(.+)"/);
            if (filenameMatch) {
                filename = filenameMatch[1];
            }
        }
        
        // Create blob and download
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        hideLoading();
        showToast('PDF generated and downloaded successfully!');
        
    } catch (error) {
        hideLoading();
        console.error('Error generating PDF:', error);
        showToast('Error generating PDF: ' + error.message, 'error');
    }
}

async function exportData() {
    try {
        showLoading('Exporting data to Excel...');
        
        // Export from server to get Excel file
        const response = await fetch('/export', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error('Failed to export data');
        }
        
        // Get the Excel blob
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = response.headers.get('Content-Disposition')?.split('filename=')[1]?.replace(/"/g, '') || 'FutureElite_Export.xlsx';
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        hideLoading();
        showToast('Data exported to Excel successfully!');
        closeExportModal();
        
    } catch (error) {
        hideLoading();
        console.error('Error exporting data:', error);
        showToast('Error exporting data: ' + error.message, 'error');
    }
}

async function importData() {
    const fileInput = document.getElementById('importFile');
    const file = fileInput.files[0];
    
    if (!file) {
        showToast('Please select a file to import', 'error');
        return;
    }
    
    try {
        await ensureStorageReady();
        
        // Check authentication
        if (!clientAuth.isAuthenticated()) {
            showToast('Please log in to import data', 'error');
            return;
        }
        
        showLoading('Importing data...');
        
        const fileName = file.name.toLowerCase();
        const isExcel = fileName.endsWith('.xlsx') || fileName.endsWith('.xls');
        
        if (isExcel) {
            // Import Excel file (matches only, replaces existing)
            const formData = new FormData();
            formData.append('file', file);
            formData.append('import_mode', 'replace'); // Default to replace for simplicity
            
            // Get CSRF token if available
            let headers = {};
            try {
                const csrfToken = await csrfManager.getToken();
                if (csrfToken) {
                    headers['X-CSRFToken'] = csrfToken;
                }
            } catch (error) {
                console.warn('Failed to get CSRF token:', error);
            }
            
            const response = await fetch('/import-excel', {
                method: 'POST',
                headers: headers,
                body: formData,
                credentials: 'include'
            });
            
            const contentType = response.headers.get('content-type') || '';
            if (!contentType.includes('application/json')) {
                const text = await response.text();
                throw new Error(`Server returned an unexpected response (${response.status}). Please try again.`);
            }
            
            const result = await response.json();
            
            if (result.success) {
                const importedMatches = result.matches || [];
                const currentUserId = clientStorage.getCurrentUserId();
                
                // Replace all existing matches
                const existingMatches = await clientStorage.getAllMatches();
                for (const match of existingMatches) {
                    if (match.user_id === currentUserId) {
                        await clientStorage.deleteMatch(match.id);
                    }
                }
                
                // Add imported matches
                for (const matchData of importedMatches) {
                    matchData.user_id = currentUserId;
                    await clientStorage.saveMatch(matchData);
                }
                
                hideLoading();
                showToast(`Successfully imported ${result.imported || importedMatches.length} matches!`, 'success');
                closeExportModal();
                
                if (typeof loadDashboardData === 'function') {
                    await loadDashboardData();
                } else {
                    setTimeout(() => window.location.reload(), 1000);
                }
            } else {
                throw new Error(result.errors?.[0] || 'Failed to import Excel file');
            }
        } else {
            // Import ZIP/JSON backup file
            const text = await file.text();
            const data = JSON.parse(text);
            
            // Import data
            await clientStorage.importData(data);
            
            hideLoading();
            showToast('Data imported successfully!', 'success');
            closeExportModal();
            setTimeout(() => window.location.reload(), 1000);
        }
        
    } catch (error) {
        hideLoading();
        console.error('Error importing data:', error);
        showToast('Error importing data: ' + error.message, 'error');
    }
}

async function importExcelData() {
    const fileInput = document.getElementById('importExcelFile');
    const file = fileInput.files[0];
    
    if (!file) {
        showToast('Please select an Excel file to import', 'error');
        return;
    }
    
    try {
        await ensureStorageReady();
        
        // Check authentication
        if (!clientAuth.isAuthenticated()) {
            showToast('Please log in to import data', 'error');
            return;
        }
        
        showLoading('Importing Excel file...');
        
        const formData = new FormData();
        formData.append('file', file);
        
        // Get import mode
        const importMode = document.querySelector('input[name="importMode"]:checked').value;
        formData.append('import_mode', importMode);
        
        // Get CSRF token if available
        let headers = {};
        try {
            const csrfToken = await csrfManager.getToken();
            if (csrfToken) {
                headers['X-CSRFToken'] = csrfToken;
            }
        } catch (error) {
            console.warn('Failed to get CSRF token:', error);
        }
        
        const response = await fetch('/import-excel', {
            method: 'POST',
            headers: headers,
            body: formData,
            credentials: 'include'
        });
        
        // Check if response is JSON before parsing
        const contentType = response.headers.get('content-type') || '';
        if (!contentType.includes('application/json')) {
            const text = await response.text();
            console.error('Non-JSON response from import-excel:', {
                status: response.status,
                contentType: contentType,
                body: text.substring(0, 200)
            });
            throw new Error(`Server returned an unexpected response (${response.status}). Please try again.`);
        }
        
        const result = await response.json();
        
        if (result.success) {
            // Check if this was a full backup import (no matches array means it was handled by /import route)
            if (result.message && result.message.includes('imported successfully')) {
                // Full backup was imported - reload page
                hideLoading();
                showToast(result.message || 'Data imported successfully!', 'success');
                closeExportModal();
                setTimeout(() => window.location.reload(), 1000);
                return;
            }
            
            // Match-only import - save matches to client-side storage
            const importedMatches = result.matches || [];
            
            const currentUserId = clientStorage.getCurrentUserId();
            if (!currentUserId) {
                throw new Error('User must be logged in to import data');
            }
            
            if (importMode === 'replace') {
                // Replace mode: delete all existing matches for current user, then add imported ones
                const existingMatches = await clientStorage.getAllMatches();
                
                // Delete all current user's matches
                for (const match of existingMatches) {
                    if (match.user_id === currentUserId) {
                        await clientStorage.deleteMatch(match.id);
                    }
                }
                
                // Add imported matches with current user_id
                for (const matchData of importedMatches) {
                    matchData.user_id = currentUserId;
                    await clientStorage.saveMatch(matchData);
                }
            } else {
                // Append mode: add imported matches, ensuring unique IDs
                const existingMatches = await clientStorage.getAllMatches();
                const existingIds = new Set(existingMatches.map(m => m.id));
                
                for (const matchData of importedMatches) {
                    // Ensure unique ID
                    if (existingIds.has(matchData.id)) {
                        matchData.id = 'match_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    }
                    matchData.user_id = currentUserId;
                    await clientStorage.saveMatch(matchData);
                    existingIds.add(matchData.id);
                }
            }
            
            hideLoading();
            const message = `Successfully imported ${result.imported || importedMatches.length} matches${result.errors && result.errors.length > 0 ? ' (with some warnings)' : ''}!`;
            showToast(message, 'success');
            if (result.errors && result.errors.length > 0) {
                console.warn('Import warnings:', result.errors);
            }
            closeExportModal();
            
            // Reload dashboard data instead of full page reload
            if (typeof loadDashboardData === 'function') {
                await loadDashboardData();
            } else {
                setTimeout(() => window.location.reload(), 1000);
            }
        } else {
            throw new Error(result.errors ? result.errors.join(', ') : 'Import failed');
        }
        
    } catch (error) {
        hideLoading();
        console.error('Error importing Excel:', error);
        showToast('Error importing Excel: ' + error.message, 'error');
    }
}

function editMatch(matchId) {
    openMatchModal(matchId);
}

// Helper functions for template
function getResultColor(result) {
    switch(result) {
        case 'Win': return 'text-green-600';
        case 'Draw': return 'text-yellow-600';
        case 'Loss': return 'text-red-600';
        default: return 'text-gray-600';
    }
}

function getCategoryBadgeColor(category) {
    switch(category) {
        case 'Pre-Season Friendly': return 'bg-blue-100 text-blue-800';
        case 'League': return 'bg-green-100 text-green-800';
        case 'Friendly': return 'bg-purple-100 text-purple-800';
        default: return 'bg-gray-100 text-gray-800';
    }
}

async function loadDashboardData() {
    try {
        await ensureStorageReady();
        
        // Check authentication
        if (!clientAuth.isAuthenticated()) {
            window.location.href = '/login';
            return;
        }
        
        // Check if user is admin - redirect to admin page
        const username = clientAuth.getCurrentUsername();
        const adminUsername = '{{ admin_username|default("") }}';
        if (adminUsername && username === adminUsername) {
            window.location.href = '/admin/users';
            return;
        }
        
        // Load settings
        const settings = await clientStorage.loadSettings();
        document.getElementById('dashboardTitle').textContent = 
            `${settings.club_name || 'Club'} - ${settings.player_name || 'Player'}`;
        document.getElementById('dashboardSeason').textContent = 
            settings.season_year ? `Season ${settings.season_year}` : '';
        
        // Load and display stats
        await updateStatsPeriod();
        
        // Load performance report data
        await loadPerformanceReport(settings);
        
        // Load recent matches
        const matches = await clientStorage.getAllMatches();
        const recentMatches = matches
            .sort((a, b) => {
                try {
                    const dateA = new Date(a.date.split(' ').reverse().join('-'));
                    const dateB = new Date(b.date.split(' ').reverse().join('-'));
                    return dateB - dateA;
                } catch {
                    return 0;
                }
            })
            .slice(0, 5);
        
        const matchesContainer = document.getElementById('recentMatchesContainer');
        if (recentMatches.length === 0) {
            matchesContainer.innerHTML = '<p class="text-gray-500 text-center py-4">No matches logged yet</p>';
        } else {
            matchesContainer.innerHTML = recentMatches.map(match => `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg mb-3">
                    <div class="flex-1">
                        <div class="flex items-center space-x-2">
                            <span class="text-sm font-medium text-gray-900">${match.opponent || 'Unknown'}</span>
                            <span class="px-2 py-1 text-xs rounded-full ${getCategoryBadgeColor(match.category || '')}">
                                ${match.category || ''}
                            </span>
                        </div>
                        <div class="text-sm text-gray-600">${match.date || ''} ‚Ä¢ ${match.location || ''}</div>
                        ${match.result ? `<div class="text-sm ${getResultColor(match.result)}">${match.result} ${match.score || ''}</div>` : ''}
                    </div>
                    <div class="text-right">
                        <div class="text-sm font-medium text-gray-900">
                            ${(() => {
                                const parts = [];
                                if (match.clean_sheets !== undefined && match.clean_sheets !== null && match.clean_sheets > 0) {
                                    parts.push(`${match.clean_sheets} CS`);
                                }
                                if (match.brodie_goals && match.brodie_goals > 0) {
                                    parts.push(`${match.brodie_goals}G`);
                                }
                                if (match.brodie_assists && match.brodie_assists > 0) {
                                    parts.push(`${match.brodie_assists}A`);
                                }
                                return parts.length > 0 ? parts.join(' ') : '0';
                            })()}
                        </div>
                        <div class="text-xs text-gray-600">${match.minutes_played || 0}m</div>
                        <button onclick="editMatch('${match.id}')" class="mt-2 text-qadsiah-red hover:text-red-700 text-sm font-medium">Edit</button>
                    </div>
                </div>
            `).join('');
        }
        
        // Load recent achievements - from server first to ensure deleted ones are removed
        let achievements = [];
        try {
            const serverData = await apiCall('/api/achievements');
            if (serverData.success && serverData.achievements) {
                achievements = serverData.achievements;
                
                // Get all client storage achievements to find deleted ones
                const clientAchievements = await clientStorage.getAllAchievements();
                const serverAchievementIds = new Set(achievements.map(a => a.id));
                
                // Remove deleted achievements from client storage
                for (const clientAch of clientAchievements) {
                    if (!serverAchievementIds.has(clientAch.id)) {
                        try {
                            await clientStorage.deleteAchievement(clientAch.id);
                        } catch (e) {
                            console.warn('Failed to delete achievement from client storage:', e);
                        }
                    }
                }
                
                // Sync server achievements to client storage
                for (const ach of achievements) {
                    try {
                        await clientStorage.saveAchievement(ach);
                    } catch (e) {
                        console.warn('Failed to sync achievement to client storage:', e);
                    }
                }
            }
        } catch (e) {
            console.warn('Could not load achievements from server, using client storage:', e);
            achievements = await clientStorage.getAllAchievements();
        }
        
        const recentAchievements = achievements
            .sort((a, b) => {
                try {
                    const dateA = new Date(a.date.split(' ').reverse().join('-'));
                    const dateB = new Date(b.date.split(' ').reverse().join('-'));
                    return dateB - dateA;
                } catch {
                    return 0;
                }
            })
            .slice(0, 5);
        
        const achievementsContainer = document.getElementById('recentAchievementsContainer');
        if (recentAchievements.length === 0) {
            achievementsContainer.innerHTML = `
                <div class="text-center py-8">
                    <p class="text-gray-500 mb-2">No achievements yet</p>
                    <a href="/achievements" class="text-sm text-qadsiah-red hover:text-red-700 font-medium">
                        Add Your First Achievement ‚Üí
                    </a>
                </div>
            `;
        } else {
            achievementsContainer.innerHTML = recentAchievements.map(ach => `
                <div class="flex items-start justify-between p-3 bg-gradient-to-r from-yellow-50 to-amber-50 rounded-lg border border-yellow-200 mb-3">
                    <div class="flex-1">
                        <div class="flex items-center space-x-2 mb-1">
                            <span class="text-sm font-semibold text-gray-900">${ach.title || ''}</span>
                            <span class="px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800 font-medium">
                                ${ach.category || ''}
                            </span>
                        </div>
                        ${ach.description ? `<div class="text-sm text-gray-700 mb-1">${ach.description}</div>` : ''}
                        <div class="flex items-center space-x-2 text-xs text-gray-500">
                            <span>${ach.date || ''}</span>
                            ${ach.season ? `<span>‚Ä¢</span><span>${ach.season}</span>` : ''}
                        </div>
                    </div>
                </div>
            `).join('') + `
                <div class="mt-4 text-center">
                    <a href="/achievements" class="text-sm text-qadsiah-red hover:text-red-700 font-medium">
                        View All Achievements ‚Üí
                    </a>
                </div>
            `;
        }
        
    } catch (error) {
        console.error('Error loading dashboard data:', error);
        showToast('Error loading dashboard: ' + error.message, 'error');
    }
}

async function updateStatsPeriod() {
    const period = document.getElementById('statsPeriod').value;
    const container = document.getElementById('statsContainer');
    
    try {
        await ensureStorageReady();
        const stats = await clientStorage.getSeasonStats(null, period);
        const avgMinutes = stats.total_matches > 0 ? (stats.minutes / stats.total_matches).toFixed(1) : '0.0';
        
        container.innerHTML = `
            <div class="text-center">
                <div class="text-2xl font-bold text-qadsiah-red">${stats.total_matches}</div>
                <div class="text-sm text-gray-600">Matches</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-green-600">${stats.wins}</div>
                <div class="text-sm text-gray-600">Wins</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-yellow-600">${stats.draws}</div>
                <div class="text-sm text-gray-600">Draws</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-red-600">${stats.losses}</div>
                <div class="text-sm text-gray-600">Losses</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-blue-600">${stats.goals}</div>
                <div class="text-sm text-gray-600">Goals</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-purple-600">${stats.assists}</div>
                <div class="text-sm text-gray-600">Assists</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-indigo-600">${stats.minutes}</div>
                <div class="text-sm text-gray-600">Minutes</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-gray-600">${avgMinutes}</div>
                <div class="text-sm text-gray-600">Avg Minutes</div>
            </div>
        `;
    } catch (error) {
        console.error('Error updating statistics:', error);
        showToast('Error loading statistics: ' + error.message, 'error');
    }
}

async function loadPerformanceReport(settings) {
    try {
        await ensureStorageReady();
        
        // Player Profile Section
        document.getElementById('playerNameHeader').textContent = settings.player_name || 'Player';
        document.getElementById('playerClub').textContent = settings.club_name || 'Not set';
        document.getElementById('playerPosition').textContent = settings.position || 'Not set';
        document.getElementById('playerFoot').textContent = settings.dominant_foot || 'Not set';
        document.getElementById('playerSeason').textContent = settings.season_year || 'Not set';
        
        // Load player photo if available
        const photoContainer = document.getElementById('playerPhotoContainer');
        if (settings.player_photo_path) {
            // Get container dimensions to ensure image fits
            const containerWidth = photoContainer.offsetWidth || 96;
            const containerHeight = photoContainer.offsetHeight || 96;
            photoContainer.innerHTML = `<img src="${settings.player_photo_path}" alt="Player Photo" class="w-full h-full object-cover" style="width: 100%; height: 100%; max-width: ${containerWidth}px; max-height: ${containerHeight}px; object-fit: cover;">`;
        }
        
        // Load physical measurements
        const measurements = await clientStorage.getAllPhysicalMeasurements();
        const latestMeasurement = measurements.sort((a, b) => {
            try {
                const dateA = new Date(a.date.split(' ').reverse().join('-'));
                const dateB = new Date(b.date.split(' ').reverse().join('-'));
                return dateB - dateA;
            } catch {
                return 0;
            }
        })[0];
        
        if (latestMeasurement) {
            document.getElementById('playerHeight').textContent = latestMeasurement.height_cm ? `${latestMeasurement.height_cm} cm` : '-';
            document.getElementById('playerWeight').textContent = latestMeasurement.weight_kg ? `${latestMeasurement.weight_kg} kg` : '-';
        } else {
            document.getElementById('playerHeight').textContent = settings.height_cm ? `${settings.height_cm} cm` : '-';
            document.getElementById('playerWeight').textContent = settings.weight_kg ? `${settings.weight_kg} kg` : '-';
        }
        
        // Calculate age group from date of birth
        if (settings.date_of_birth) {
            try {
                const dob = new Date(settings.date_of_birth);
                const today = new Date();
                let age = today.getFullYear() - dob.getFullYear();
                const monthDiff = today.getMonth() - dob.getMonth();
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < dob.getDate())) {
                    age--;
                }
                const ageGroup = age <= 12 ? 'U12' : age <= 13 ? 'U13' : age <= 14 ? 'U14' : age <= 15 ? 'U15' : age <= 16 ? 'U16' : age <= 17 ? 'U17' : 'U18+';
                document.getElementById('playerAgeGroup').textContent = ageGroup;
            } catch (e) {
                document.getElementById('playerAgeGroup').textContent = '-';
            }
        } else {
            document.getElementById('playerAgeGroup').textContent = '-';
        }
        
        // PHV Status
        if (settings.phv_date && settings.phv_age) {
            const phvDate = new Date(settings.phv_date);
            const today = new Date();
            const phvStatus = today >= phvDate ? 'Post-PHV' : 'Pre-PHV';
            document.getElementById('playerPHVStatus').textContent = `${phvStatus} (${settings.phv_age.toFixed(1)} years)`;
            document.getElementById('phvStageText').textContent = phvStatus === 'Post-PHV' ? 'Advanced PHV Stage' : 'Pre-PHV Stage';
        } else {
            document.getElementById('playerPHVStatus').textContent = 'Not calculated';
            document.getElementById('phvStageText').textContent = 'PHV Not Calculated';
        }
        
        // Physical Metrics (from physical_metrics data)
        const physicalMetrics = await clientStorage.getAllPhysicalMetrics();
        const latestMetrics = physicalMetrics.sort((a, b) => {
            try {
                const dateA = new Date(a.date.split(' ').reverse().join('-'));
                const dateB = new Date(b.date.split(' ').reverse().join('-'));
                return dateB - dateA;
            } catch {
                return 0;
            }
        })[0];
        
        if (latestMetrics) {
            const sprintSpeed = latestMetrics.sprint_speed_ms || latestMetrics.sprint_speed_kmh ? 
                (latestMetrics.sprint_speed_ms ? `${latestMetrics.sprint_speed_ms} m/s` : `${latestMetrics.sprint_speed_kmh} km/h`) : 
                'Not recorded';
            document.getElementById('sprintSpeed').textContent = sprintSpeed;
            document.getElementById('verticalJump').textContent = latestMetrics.vertical_jump_cm ? `${latestMetrics.vertical_jump_cm} cm` : 'Not recorded';
            document.getElementById('beepTest').textContent = latestMetrics.beep_test_level ? `${latestMetrics.beep_test_level}` : 'Not recorded';
        } else {
            document.getElementById('sprintSpeed').textContent = 'Not recorded';
            document.getElementById('verticalJump').textContent = 'Not recorded';
            document.getElementById('beepTest').textContent = 'Not recorded';
        }
        
        // Match Statistics
        const matches = await clientStorage.getAllMatches();
        const completedMatches = matches.filter(m => !m.is_fixture);
        
        const totalMatches = completedMatches.length;
        const totalGoals = completedMatches.reduce((sum, m) => sum + (m.brodie_goals || 0), 0);
        const totalAssists = completedMatches.reduce((sum, m) => sum + (m.brodie_assists || 0), 0);
        const totalMinutes = completedMatches.reduce((sum, m) => sum + (m.minutes_played || 0), 0);
        
        document.getElementById('totalMatches').textContent = totalMatches;
        document.getElementById('totalGoals').textContent = totalGoals;
        document.getElementById('totalAssists').textContent = totalAssists;
        document.getElementById('totalMinutes').textContent = totalMinutes;
        
        // Performance Ratios
        const goalsPer60 = totalMinutes > 0 ? ((totalGoals / totalMinutes) * 60).toFixed(2) : '0.00';
        const assistsPer60 = totalMinutes > 0 ? ((totalAssists / totalMinutes) * 60).toFixed(2) : '0.00';
        const goalContribPer60 = totalMinutes > 0 ? (((totalGoals + totalAssists) / totalMinutes) * 60).toFixed(2) : '0.00';
        const minutesPerGoal = totalGoals > 0 ? Math.round(totalMinutes / totalGoals) : '-';
        const minutesPerContribution = (totalGoals + totalAssists) > 0 ? Math.round(totalMinutes / (totalGoals + totalAssists)) : '-';
        
        document.getElementById('goalsPer60').textContent = goalsPer60;
        document.getElementById('minutesPerContribution').textContent = minutesPerContribution !== '-' ? minutesPerContribution : '-';
        
        // Scout Snapshot
        document.getElementById('scoutGoalsPer60').textContent = goalsPer60;
        document.getElementById('scoutAssistsPer60').textContent = assistsPer60;
        document.getElementById('scoutGoalContribPer60').textContent = goalContribPer60;
        document.getElementById('scoutMinutesPerGoal').textContent = minutesPerGoal;
        
        // Key Strengths (based on performance)
        const strengths = [];
        if (parseFloat(goalsPer60) >= 1.0) {
            strengths.push('Clinical Finishing');
        }
        if (parseFloat(assistsPer60) >= 0.5) {
            strengths.push('Creative Playmaking');
        }
        if (totalMatches >= 10) {
            strengths.push('Consistent Performer');
        }
        if (totalMinutes >= 500) {
            strengths.push('High Match Involvement');
        }
        if (strengths.length === 0) {
            strengths.push('Building Performance Profile');
        }
        
        const strengthsList = document.getElementById('keyStrengths');
        strengthsList.innerHTML = strengths.map(s => `<li>${s}</li>`).join('');
        
    } catch (error) {
        console.error('Error loading performance report:', error);
    }
}

// Load dashboard data on page load
document.addEventListener('DOMContentLoaded', function() {
    loadDashboardData();
});
</script>
{% endblock %}
