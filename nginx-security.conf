# ============================================================================
# NGINX Security Configuration for FutureElite Production
# ============================================================================
# 
# This configuration provides comprehensive protection against:
# - Environment variable file access (.env, .env.bak, etc.)
# - Git metadata access (.git/, .gitignore, etc.)
# - Backup file access (.bak, .save, .old, etc.)
# - Build artifact exposure (__pycache__, *.pyc, node_modules)
# - Admin path enumeration
# - Framework debug endpoints
#
# Usage:
#   1. Include this file in your main nginx.conf:
#      include /path/to/nginx-security.conf;
#   2. Or copy relevant sections into your server block
#
# ============================================================================

# ============================================================================
# BLOCK 1: Environment Variable Files
# ============================================================================
# Block all variations of .env files that could contain secrets
# These patterns match common backup and variant naming conventions

location ~ /\.env {
    # Block .env, .env.bak, .env.save, .env.backup, .env.old, etc.
    deny all;
    return 404;
    access_log off;
    log_not_found off;
}

location ~ /\.env\. {
    # Block .env.* patterns (covers .env.bak, .env.save, etc.)
    deny all;
    return 404;
    access_log off;
    log_not_found off;
}

location ~ /\.env[0-9] {
    # Block .env1, .env2, etc.
    deny all;
    return 404;
    access_log off;
    log_not_found off;
}

# ============================================================================
# BLOCK 2: Git Metadata and Version Control
# ============================================================================
# Prevent access to Git repository metadata which could expose:
# - Source code history
# - Repository URLs
# - Commit messages
# - Branch information

location ~ /\.git {
    # Block .git/, .gitignore, .gitattributes, .gitmodules, etc.
    deny all;
    return 404;
    access_log off;
    log_not_found off;
}

location ~ /\.git/ {
    # Explicitly block .git/ directory and all contents
    deny all;
    return 404;
    access_log off;
    log_not_found off;
}

location ~ /\.svn {
    # Block Subversion metadata
    deny all;
    return 404;
    access_log off;
    log_not_found off;
}

location ~ /\.hg {
    # Block Mercurial metadata
    deny all;
    return 404;
    access_log off;
    log_not_found off;
}

# ============================================================================
# BLOCK 3: Backup and Temporary Files
# ============================================================================
# Block common backup file patterns that may contain sensitive data

location ~ \.(bak|backup|save|old|orig|swp|swo|tmp|temp)$ {
    # Block files ending in backup extensions
    deny all;
    return 404;
    access_log off;
    log_not_found off;
}

location ~ /backup {
    # Block /backup/ directories
    deny all;
    return 404;
    access_log off;
    log_not_found off;
}

location ~ /backups {
    # Block /backups/ directories
    deny all;
    return 404;
    access_log off;
    log_not_found off;
}

location ~ /old {
    # Block /old/ directories
    deny all;
    return 404;
    access_log off;
    log_not_found off;
}

location ~ /temp {
    # Block /temp/ directories
    deny all;
    return 404;
    access_log off;
    log_not_found off;
}

# ============================================================================
# BLOCK 4: Configuration Files
# ============================================================================
# Block access to configuration files that may contain secrets

location ~ /(wp-config|config|aws-config|aws\.config)\.(php|js|json|bak|old|save)$ {
    # Block WordPress, general config, and AWS config files
    deny all;
    return 404;
    access_log off;
    log_not_found off;
}

location ~ /config\.(php|js|json|yaml|yml|toml|ini)$ {
    # Block generic config files
    deny all;
    return 404;
    access_log off;
    log_not_found off;
}

# ============================================================================
# BLOCK 5: Build Artifacts and Development Files
# ============================================================================
# Prevent exposure of build artifacts, source code, and development files

location ~ /__pycache__ {
    # Block Python bytecode cache directories
    deny all;
    return 404;
    access_log off;
    log_not_found off;
}

location ~ \.pyc$ {
    # Block Python compiled bytecode files
    deny all;
    return 404;
    access_log off;
    log_not_found off;
}

location ~ \.pyo$ {
    # Block Python optimized bytecode files
    deny all;
    return 404;
    access_log off;
    log_not_found off;
}

location ~ /node_modules {
    # Block node_modules directory (should never be accessible)
    deny all;
    return 404;
    access_log off;
    log_not_found off;
}

location ~ \.(map)$ {
    # Block source map files in production (expose source code)
    # Uncomment if you want to block source maps:
    # deny all;
    # return 404;
    # access_log off;
    # log_not_found off;
}

# ============================================================================
# BLOCK 6: IDE and Editor Files
# ============================================================================
# Block IDE configuration files that may expose project structure

location ~ /\.(vscode|idea|settings|project) {
    # Block VS Code, IntelliJ IDEA, and other IDE files
    deny all;
    return 404;
    access_log off;
    log_not_found off;
}

location ~ \.(swp|swo|~)$ {
    # Block Vim swap files
    deny all;
    return 404;
    access_log off;
    log_not_found off;
}

# ============================================================================
# BLOCK 7: Database and Dump Files
# ============================================================================
# Block database dump files that may contain sensitive data

location ~ \.(sql|dump|db|sqlite|sqlite3)$ {
    # Block SQL and database files
    # NOTE: Adjust if you need to serve SQLite files for legitimate purposes
    # For this application, we don't serve database files, so block them
    deny all;
    return 404;
    access_log off;
    log_not_found off;
}

location ~ /(database|dump|backup)\.sql$ {
    # Block common database dump file names
    deny all;
    return 404;
    access_log off;
    log_not_found off;
}

# ============================================================================
# BLOCK 8: PHP and Framework-Specific Files
# ============================================================================
# Block PHP files and framework-specific files (even though this is Python)

location ~ \.php$ {
    # Block all PHP files (this is a Python app, no PHP should exist)
    deny all;
    return 404;
    access_log off;
    log_not_found off;
}

location ~ /(phpinfo|phpmyadmin|xmlrpc|wp-admin|wp-login) {
    # Block common WordPress and PHP admin paths
    deny all;
    return 404;
    access_log off;
    log_not_found off;
}

# ============================================================================
# BLOCK 9: Hidden Files and Directories
# ============================================================================
# Block all hidden files and directories (starting with .)

location ~ /\. {
    # Block all hidden files and directories
    # NOTE: This is a catch-all, but we allow specific exceptions below
    # Make sure legitimate hidden files (like .well-known) are handled before this
    
    # Allow .well-known for Let's Encrypt and other standards
    if ($uri ~ "^/\.well-known/") {
        break;
    }
    
    # Allow .htaccess if using Apache (though nginx doesn't use it)
    # This is just for compatibility
    
    # Block everything else
    deny all;
    return 404;
    access_log off;
    log_not_found off;
}

# ============================================================================
# BLOCK 10: Admin Path Protection (Optional - Rate Limiting)
# ============================================================================
# Add rate limiting for admin paths to prevent brute force and enumeration
# This should be placed in your main server block, not here
# Example:
#
# limit_req_zone $binary_remote_addr zone=admin_limit:10m rate=10r/m;
#
# location /admin {
#     limit_req zone=admin_limit burst=5 nodelay;
#     proxy_pass http://your_backend;
# }

# ============================================================================
# ALLOW: Legitimate Hidden Files
# ============================================================================
# Allow .well-known for Let's Encrypt, security.txt, etc.
# This should be placed BEFORE the /\. block above

location = /.well-known/acme-challenge/ {
    # Allow Let's Encrypt ACME challenges
    root /var/www/html;
    allow all;
}

location = /.well-known/security.txt {
    # Allow security.txt (security contact information)
    root /var/www/html;
    allow all;
}

location = /robots.txt {
    # Allow robots.txt (should be handled by your app, but allow direct access)
    # This is handled by your Flask app, but nginx can serve it if needed
    # Uncomment if you want nginx to serve it:
    # root /var/www/html;
    # allow all;
}

# ============================================================================
# SECURITY HEADERS (Recommended)
# ============================================================================
# Add these headers in your main server block:
#
# add_header X-Frame-Options "SAMEORIGIN" always;
# add_header X-Content-Type-Options "nosniff" always;
# add_header X-XSS-Protection "1; mode=block" always;
# add_header Referrer-Policy "strict-origin-when-cross-origin" always;
# add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' https://js.stripe.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https://api.stripe.com; frame-src 'self' https://js.stripe.com;" always;
#
# Strict-Transport-Security should be set at the CDN level (Cloudflare)
# or in your main server block:
# add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

# ============================================================================
# RATE LIMITING ZONES (Add to http block in main nginx.conf)
# ============================================================================
# Add these to your main nginx.conf http block:
#
# # Rate limiting for 404 requests (reconnaissance detection)
# limit_req_zone $binary_remote_addr zone=recon_limit:10m rate=10r/s;
#
# # Rate limiting for admin paths
# limit_req_zone $binary_remote_addr zone=admin_limit:10m rate=10r/m;
#
# # Rate limiting for login attempts
# limit_req_zone $binary_remote_addr zone=login_limit:10m rate=5r/m;
#
# Then apply in your server block:
# location / {
#     limit_req zone=recon_limit burst=20 nodelay;
#     proxy_pass http://your_backend;
# }

# ============================================================================
# LOGGING FOR SECURITY MONITORING
# ============================================================================
# Add custom log format to track blocked requests:
#
# log_format security_blocked '$remote_addr - $remote_user [$time_local] '
#                            '"$request" $status $body_bytes_sent '
#                            '"$http_referer" "$http_user_agent" '
#                            'blocked_reason="$blocked_reason"';
#
# Then use in blocked locations:
# access_log /var/log/nginx/security_blocked.log security_blocked;

# ============================================================================
# NOTES
# ============================================================================
#
# 1. Order matters: More specific rules should come before general rules
# 2. Test after deployment: Verify legitimate requests still work
# 3. Monitor logs: Watch for false positives
# 4. Adjust as needed: Some rules may need modification for your use case
#
# 5. If using a reverse proxy (like Cloudflare), some of these rules
#    may be redundant but provide defense in depth
#
# 6. For managed hosting (Render, Railway, etc.), you may not have direct
#    nginx access. In that case, rely on Cloudflare WAF rules and
#    application-level protection
#
# ============================================================================

